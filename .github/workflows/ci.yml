name: CI

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          coverage: none

      - name: Install Composer Dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Prepare Laravel Env
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Run Auth Feature Tests
        run: vendor/bin/pest --filter AuthFlowTest

  frontend-checks:
    name: Frontend Lint and Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: https://api.example.com
          NEXT_PUBLIC_FRONTEND_URL: https://app.example.com
          NEXT_PUBLIC_SESSION_COOKIE_NAME: laravel-session

  backend-security-config:
    name: Backend Security Config Gate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          coverage: none

      - name: Install Composer Dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Prepare Laravel Env
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Run Strict Auth Config Check
        run: php artisan auth:config-check --strict
        env:
          APP_ENV: production
          APP_DEBUG: "false"
          APP_URL: https://api.example.com
          SESSION_SECURE_COOKIE: "true"
          SESSION_SAME_SITE: lax
          TRUSTED_FRONTEND_ORIGINS: https://app.example.com
          SANCTUM_STATEFUL_DOMAINS: app.example.com
